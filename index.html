<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ASAS SD NEGERI YANTI ‚Äî ExamBrowser Web</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0e639c">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Arial, sans-serif; }
    body { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: #333; line-height: 1.6; padding: 20px; min-height: 100vh; }
    .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.2); overflow: hidden; }
    header { background: linear-gradient(135deg, #2d2d30 0%, #4a4a4f 100%); padding: 20px; border-bottom: 3px solid #0e639c; text-align: center; color: white; }
    h1 { color: #fff; font-size: 28px; margin-bottom: 4px; }
    .subtitle { color: #cccccc; font-size: 14px; font-weight: 300; }
    .content { padding: 22px; }
    .menu { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 10px; padding: 18px; background: #f8f9fa; border-radius: 8px; border: 2px solid #e9ecef; align-items: center; }
    input[type="text"], input[type="number"], textarea { padding: 8px; border-radius: 6px; border: 2px solid #ced4da; background: white; color: #495057; font-size: 14px; transition: border-color .3s; }
    button { background: #0e639c; color: #fff; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: all .18s; font-weight: 700; }
    button:hover { background: #0d5a8a; }
    .card { background: white; border-radius: 10px; padding: 18px; box-shadow: 0 4px 15px rgba(0,0,0,.08); margin-bottom: 15px; border: 2px solid #e9ecef; }
    .time { font-weight: bold; color: #e11d48; margin-bottom: 10px; font-size: 18px; text-align: center; padding: 8px; border-radius: 8px; background: #fff5f5; border: 2px solid #e11d48; }
    .panel-buttons { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
    .panel-buttons button { width: 44px; height: 44px; border-radius: 8px; border: 2px solid #e6e6e6; background: white; color: #111; font-weight: 700; cursor: pointer; }
    .panel-buttons button.answered { background: #ecfdf5; border-color: #bbf7d0; color: #166534; }
    .panel-buttons button.marked { background: #fffbeb; border-color: #fde68a; color: #92400e; }
    .panel-buttons button.current { background: #eff6ff; border-color: #bfdbfe; color: #0f4aa1; }
    .score-display { font-size: 22px; font-weight: 700; text-align: center; padding: 12px; margin: 12px 0; border-radius: 8px; background: linear-gradient(135deg, #22c55e, #16a34a); color: #fff; }
    .no-select { user-select: none; -webkit-user-select: none; -ms-user-select: none; }
    .answer-btn { display: block; width: 100%; margin: 8px 0; padding: 12px; text-align: left; background: #ffffff; color: #000000; border: 2px solid #cbd5e1; border-radius: 8px; cursor: pointer; font-size: 16px; }
    .answer-btn:hover { background: #f1f5f9; color: #000000; }
    .answer-btn.active { background: #e0f2fe; color: #000000; border-color: #38bdf8; font-weight: 700; }
    .info-box { background: #e0f2fe; border: 2px solid #38bdf8; border-radius: 10px; padding: 15px; margin: 15px 0; }
    .warning-box { background: #fef3c7; border: 2px solid #f59e0b; border-radius: 10px; padding: 15px; margin: 15px 0; }
  </style>
</head>
<body class="no-select">
  <div class="container" id="app">
    <header>
      <h1>ASESMENT SUMATIF AKHIR SEMESTER</h1>
      <h1>SEKOLAH DASAR NEGERI YANTI</h1>
      <p class="subtitle">Tahun Ajaran 2025/2026 ‚Äî Mode Ujian Terkunci</p>
    </header>
    
    <div class="content">
      <div class="menu">
        <!-- INPUT NISN DAN NAMA -->
        <label style="width:100px">NISN:
          <input id="nisn" type="text" placeholder="10 digit" style="width:100px;margin-left:8px">
        </label>
        <label style="width:220px">Nama Siswa:
          <input id="namaSiswa" type="text" placeholder="Masukkan nama lengkap" style="width:220px;margin-left:8px">
        </label>
        <label>Waktu (menit):
          <input id="setTime" type="number" value="30" min="1" max="180" style="width:80px;margin-left:8px">
        </label>
        
        <!-- TOMBOL UTAMA -->
        <button onclick="startTest()" id="startBtn">üöÄ Mulai Tes</button>
        <button onclick="finishTest()" id="finishBtn">‚úÖ Selesai</button>
        <button onclick="exportJawaban()">üì§ Ekspor Jawaban</button>
        <button onclick="cekDataSiswa()">üîç Cek Data</button>
        <button onclick="resetUjian()">üîÑ Reset</button>
      </div>
      
      <!-- TEMPAT SOAL DAN NAVIGASI -->
      <div id="quiz" class="card"></div>
      <div id="panel" class="card"></div>
      <div id="result" class="card" style="display:none"></div>
    </div>
  </div>

<script>
// ==================== STATE / VARIABEL GLOBAL ====================
let questions = [];
let current = 0;
let answers = {};
let marked = {};
let started = false;
let finished = false;
let timer = null;
let timeLeft = 0;
let currentFileName = '';

// ==================== FUNGSI LOAD SOAL DARI JSON ====================
async function loadSoalJSON() {
  // Ambil parameter ?mapel=... dari URL
  const urlParams = new URLSearchParams(window.location.search);
  const mapel = urlParams.get('mapel');
  
  // Tentukan file yang akan di-load
  let fileToLoad = 'soal.json';
  if (mapel) {
    fileToLoad = `${mapel}.json`;
  }
  
  // Coba load file utama
  try {
    const response = await fetch(`./${fileToLoad}`);
    if (response.ok) {
      const data = await response.json();
      processData(data, fileToLoad);
      return;
    }
  } catch (err) {
    console.log('Gagal load file utama:', err.message);
  }
  
  // Jika gagal, coba encode spasi (%20)
  if (mapel) {
    const encodedFile = `${encodeURIComponent(mapel)}.json`;
    try {
      const encodedResponse = await fetch(`./${encodedFile}`);
      if (encodedResponse.ok) {
        const data = await encodedResponse.json();
        processData(data, encodedFile);
        return;
      }
    } catch (err) {
      console.log('Gagal load encoded file:', err.message);
    }
  }
  
  // Fallback ke soal.json
  try {
    const fallback = await fetch('./soal.json');
    const data = await fallback.json();
    processData(data, 'soal.json');
  } catch (err) {
    alert('‚ùå Gagal memuat soal. Pastikan file soal.json ada.');
  }
}

function processData(data, fileName) {
  questions = Array.isArray(data) ? data : 
             (Array.isArray(data.soal) ? data.soal : []);
  currentFileName = fileName;
  
  console.log(`‚úÖ ${questions.length} soal dimuat dari ${fileName}`);
  
  // Setup auto-load saat input nama/NISN berubah
  setupAutoLoad();
  
  render();
}

// ==================== FUNGSI UTAMA PENYIMPANAN ====================

// Fungsi untuk membuat KEY penyimpanan unik
function getStorageKey() {
  // Prioritas 1: Pakai NISN jika ada
  const nisn = document.getElementById('nisn').value.trim();
  const mapel = currentFileName.replace('.json', '') || 'soal';
  
  if (nisn) {
    return `examProgress_${mapel}_NISN${nisn}`;
  }
  
  // Prioritas 2: Pakai nama jika NISN kosong
  const nama = document.getElementById('namaSiswa').value.trim();
  if (nama) {
    // Bersihkan nama dari spasi dan karakter khusus
    const namaClean = nama.replace(/\s+/g, '_').replace(/[^\w]/g, '');
    return `examProgress_${mapel}_${namaClean}`;
  }
  
  // Prioritas 3: Guest dengan timestamp (fallback)
  const timestamp = sessionStorage.getItem('guest_timestamp') || 
                    Date.now().toString(36);
  sessionStorage.setItem('guest_timestamp', timestamp);
  return `examProgress_${mapel}_guest_${timestamp}`;
}

// Fungsi SIMPAN jawaban ke localStorage
function saveProgress() {
  const nisn = document.getElementById('nisn').value.trim();
  const nama = document.getElementById('namaSiswa').value.trim();
  
  // Minimal harus ada nama untuk menyimpan
  if (!nama && !nisn) {
    console.log('‚ö†Ô∏è Tidak bisa simpan: nama dan NISN kosong');
    return;
  }
  
  const progress = {
    answers: answers,
    marked: marked,
    current: current,
    timeLeft: timeLeft,
    started: started,
    finished: finished,
    currentFileName: currentFileName,
    nisn: nisn,
    namaSiswa: nama,
    setTime: document.getElementById('setTime').value,
    timestamp: Date.now(),
    totalQuestions: questions.length
  };
  
  const key = getStorageKey();
  localStorage.setItem(key, JSON.stringify(progress));
  
  console.log('üíæ DISIMPAN:', { 
    key, 
    nama: nama || '(tanpa nama)',
    nisn: nisn || '(tanpa NISN)',
    jawaban: Object.keys(answers).length,
    waktu: timeLeft 
  });
}

// Fungsi LOAD jawaban dari localStorage
function loadProgress() {
  const key = getStorageKey();
  const saved = localStorage.getItem(key);
  
  if (!saved) {
    console.log('üì≠ Tidak ada progress tersimpan untuk:', key);
    return false;
  }
  
  try {
    const progress = JSON.parse(saved);
    
    // Validasi: pastikan paket soal sama
    if (progress.currentFileName !== currentFileName) {
      console.log('‚ö†Ô∏è Paket soal berbeda, abaikan progress lama');
      return false;
    }
    
    // Auto-isi NISN dan Nama dari data tersimpan
    if (progress.nisn && !document.getElementById('nisn').value) {
      document.getElementById('nisn').value = progress.nisn;
    }
    if (progress.namaSiswa && !document.getElementById('namaSiswa').value) {
      document.getElementById('namaSiswa').value = progress.namaSiswa;
    }
    
    // Restore semua state
    answers = progress.answers || {};
    marked = progress.marked || {};
    current = progress.current || 0;
    timeLeft = progress.timeLeft || 0;
    started = progress.started || false;
    finished = progress.finished || false;
    
    // Jika ujian sedang berjalan, lanjutkan timer
    if (started && !finished && timeLeft > 0) {
      startTimer();
      console.log('‚è∞ Timer dilanjutkan, sisa waktu:', timeLeft, 'detik');
    }
    
    console.log('‚úÖ Progress DIMUAT:', {
      nama: progress.namaSiswa,
      jawaban: Object.keys(answers).length,
      soalSekarang: current + 1,
      sisaWaktu: timeLeft
    });
    
    return true;
    
  } catch (e) {
    console.error('‚ùå Gagal load progress:', e);
    // Hapus data corrupt
    localStorage.removeItem(key);
    return false;
  }
}

// Setup auto-load saat input berubah
function setupAutoLoad() {
  // Auto-load progress saat nama/NISN diisi
  document.getElementById('nisn').addEventListener('input', function() {
    setTimeout(function() {
      if (document.getElementById('namaSiswa').value.trim() || 
          document.getElementById('nisn').value.trim()) {
        loadProgress();
        render();
      }
    }, 300);
  });
  
  document.getElementById('namaSiswa').addEventListener('input', function() {
    setTimeout(function() {
      if (document.getElementById('namaSiswa').value.trim() || 
          document.getElementById('nisn').value.trim()) {
        loadProgress();
        render();
      }
    }, 300);
  });
}

// ==================== FUNGSI RENDER TAMPILAN ====================
function render() {
  const quizEl = document.getElementById('quiz');
  const panelEl = document.getElementById('panel');
  
  // TAMPILAN AWAL (belum mulai ujian)
  if (!started) {
    const mapelName = currentFileName.replace('.json', '');
    const nisn = document.getElementById('nisn').value.trim();
    const nama = document.getElementById('namaSiswa').value.trim();
    
    // Cek apakah ada progress tersimpan
    const key = getStorageKey();
    const saved = localStorage.getItem(key);
    let progressInfo = '';
    
    if (saved && (nisn || nama)) {
      try {
        const progress = JSON.parse(saved);
        const totalJawaban = Object.keys(progress.answers || {}).length;
        const waktuTersisa = Math.floor(progress.timeLeft / 60) + ":" + 
                            String(progress.timeLeft % 60).padStart(2, '0');
        
        progressInfo = `
          <div class="info-box">
            <h3>üíæ JAWABAN TERSIMPAN DITEMUKAN!</h3>
            <p><strong>Siswa:</strong> ${progress.namaSiswa || nama}</p>
            <p><strong>Jawaban tersimpan:</strong> ${totalJawaban} dari ${questions.length} soal</p>
            <p><strong>Status:</strong> ${progress.finished ? '‚úÖ SELESAI' : '‚è≥ MASIH BERLANGSUNG'}</p>
            ${!progress.finished ? `<p><strong>Waktu tersisa:</strong> ${waktuTersisa}</p>` : ''}
            
            <div style="margin-top:15px; display:flex; gap:10px;">
              <button onclick="lanjutkanUjian()" style="background:#0ea5e9; color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer;">
                üöÄ ${progress.finished ? 'LIHAT HASIL' : 'LANJUTKAN UJIAN'}
              </button>
              <button onclick="hapusProgressSiswa()" style="background:#ef4444; color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer;">
                üóëÔ∏è HAPUS DATA INI
              </button>
            </div>
          </div>
        `;
      } catch (e) {
        console.error('Error membaca progress:', e);
      }
    }
    
    // Info siswa yang sedang login
    let infoSiswa = '';
    if (nisn || nama) {
      infoSiswa = `
        <div style="background:#ecfdf5; border:1px solid #a7f3d0; border-radius:8px; padding:12px; margin:10px 0;">
          <p style="margin:5px 0;"><strong>üë§ Siswa:</strong> ${nama || '(belum diisi)'}</p>
          ${nisn ? `<p style="margin:5px 0;"><strong>üî¢ NISN:</strong> ${nisn}</p>` : ''}
          ${key ? `<p style="margin:5px 0; font-size:12px; color:#666;"><strong>ID Sesi:</strong> ${key}</p>` : ''}
        </div>
      `;
    }
    
    // Warning jika nama/NISN kosong
    let warning = '';
    if (!nisn && !nama) {
      warning = `
        <div class="warning-box">
          <strong>‚ö†Ô∏è PERHATIAN:</strong> Isi Nama atau NISN untuk menyimpan jawaban!
        </div>
      `;
    }
    
    quizEl.innerHTML = `
      <div style="padding:20px;text-align:center">
        <h2>üéì SELAMAT DATANG DI UJIAN ONLINE</h2>
        <p><strong>Paket Soal:</strong> ${mapelName}</p>
        
        ${infoSiswa}
        ${warning}
        ${progressInfo}
        
        <p style="margin-top:20px;">Isi <strong>Nama dan/atau NISN</strong>, atur waktu, lalu klik <strong>"Mulai Tes"</strong>.</p>
        
        <div style="margin-top:25px; padding:15px; background:#f8fafc; border-radius:8px; border:1px dashed #cbd5e1;">
          <h4>üìã Petunjuk Singkat:</h4>
          <ol style="text-align:left; margin:10px 0 0 20px;">
            <li>Isi NISN (jika ada) untuk identifikasi yang lebih akurat</li>
            <li>Isi Nama Lengkap sesuai data sekolah</li>
            <li>Atur waktu pengerjaan (default: 30 menit)</li>
            <li>Klik "Mulai Tes" untuk memulai ujian</li>
            <li>Jawaban otomatis tersimpan saat dikerjakan</li>
          </ol>
        </div>
      </div>
    `;
    
    panelEl.innerHTML = '';
    return;
  }
  
  // TAMPILAN SAAT UJIAN SUDAH SELESAI
  if (finished) return;
  
  // TAMPILAN SOAL SAAT UJIAN BERLANGSUNG
  const q = questions[current];
  
  // Timer
  let html = `<div class="time">‚è≥ Sisa Waktu: ${Math.floor(timeLeft/60)}:${String(timeLeft%60).padStart(2,'0')}</div>`;
  
  // Info siswa di pojok
  const nama = document.getElementById('namaSiswa').value.trim();
  const nisn = document.getElementById('nisn').value.trim();
  html += `<div style="background:#f0f9ff; padding:8px 12px; border-radius:6px; margin-bottom:15px; border:1px solid #bae6fd;">
            <strong>üë§</strong> ${nama || 'Tanpa Nama'} ${nisn ? `| üî¢ ${nisn}` : ''}
           </div>`;
  
  // Soal
  html += `<div style="font-size:18px;margin-bottom:20px">
            <strong>Soal ${current+1} dari ${questions.length}:</strong> ${q.q}
           </div>`;
  
  // Pilihan berdasarkan tipe soal
  if (q.type === 'multiple_choice') {
    q.choices.forEach((choice, i) => {
      const isSelected = answers[q.id] === i;
      html += `<button onclick="selectChoice(${i})" class="answer-btn ${isSelected ? 'active' : ''}">
                ${String.fromCharCode(65+i)}. ${choice}
              </button>`;
    });
  } 
  else if (q.type === 'fill_blank') {
    html += `<input type="text" placeholder="Ketik jawaban Anda..." 
                    value="${answers[q.id] || ''}" 
                    oninput="updateFillBlank(this.value)"
                    style="width:100%;padding:12px;font-size:16px;border:2px solid #0e639c;border-radius:6px;">`;
  }
  else if (q.type === 'essay') {
    html += `<textarea placeholder="Tulis jawaban uraian..." 
                      oninput="updateEssay(this.value)"
                      style="width:100%;min-height:150px;padding:12px;font-size:16px;border:2px solid #0e639c;border-radius:6px;">${answers[q.id] || ''}</textarea>`;
  }
  else if (q.type === 'multiple_answer') {
    q.choices.forEach((choice, i) => {
      const isChecked = answers[q.id] && answers[q.id].includes(i);
      html += `<label style="display:block;margin:10px 0;padding:12px;border-radius:6px;background:${isChecked?'#f0f9ff':'transparent'};border:1px solid #e5e7eb;">
                <input type="checkbox" ${isChecked?'checked':''} 
                       onchange="selectMultiple(${i})" 
                       style="margin-right:10px; transform:scale(1.2);">
                ${String.fromCharCode(65+i)}. ${choice}
              </label>`;
    });
  }
  
  // Tombol navigasi
  html += `<div style="margin-top:25px;display:flex;gap:10px;flex-wrap:wrap;">
    <button onclick="goto(${current-1})" ${current===0?'disabled':''} style="flex:1;">‚¨ÖÔ∏è Sebelumnya</button>
    <button onclick="toggleMark()" style="flex:1; background:${marked[q.id]?'#fbbf24':'#6b7280'};">
      ${marked[q.id]?'‚úì Ditandai':'üö© Tandai'}
    </button>
    <button onclick="goto(${current+1})" ${current===questions.length-1?'disabled':''} style="flex:1;">Selanjutnya ‚û°Ô∏è</button>
    <button onclick="finishTest()" style="flex:1; background:#dc2626;">‚úÖ Kumpulkan</button>
  </div>`;
  
  quizEl.innerHTML = html;
  
  // Panel navigasi angka
  let panelHtml = '<div style="margin-bottom:10px;"><strong>Navigasi Soal:</strong></div><div class="panel-buttons">';
  questions.forEach((q, i) => {
    let cls = [];
    if (answers[q.id] !== undefined && answers[q.id] !== '' && 
        (!Array.isArray(answers[q.id]) || answers[q.id].length > 0)) {
      cls.push('answered');
    }
    if (marked[q.id]) cls.push('marked');
    if (i === current) cls.push('current');
    panelHtml += `<button onclick="goto(${i})" class="${cls.join(' ')}" title="Soal ${i+1}">${i+1}</button>`;
  });
  panelHtml += '</div>';
  
  // Info status
  const totalAnswered = Object.keys(answers).filter(k => 
    answers[k] !== undefined && answers[k] !== '' && 
    (!Array.isArray(answers[k]) || answers[k].length > 0)
  ).length;
  const totalMarked = Object.keys(marked).filter(k => marked[k]).length;
  
  panelHtml += `
    <div style="margin-top:15px; padding:10px; background:#f8fafc; border-radius:8px; border:1px solid #e5e7eb;">
      <div style="display:flex; justify-content:space-between;">
        <span>‚úÖ Terjawab: <strong>${totalAnswered}/${questions.length}</strong></span>
        <span>üö© Ditandai: <strong>${totalMarked}</strong></span>
      </div>
      <div style="margin-top:5px; font-size:12px; color:#6b7280;">
        Jawaban otomatis tersimpan setiap 10 detik
      </div>
    </div>
  `;
  
  panelEl.innerHTML = panelHtml;
}

// ==================== FUNGSI NAVIGASI & JAWABAN ====================
function selectChoice(i) { 
  answers[questions[current].id] = i; 
  render(); 
  saveProgress(); 
}

function toggleMark() { 
  marked[questions[current].id] = !marked[questions[current].id]; 
  render(); 
  saveProgress(); 
}

function goto(i) { 
  if (i >= 0 && i < questions.length) { 
    current = i; 
    render(); 
    saveProgress(); 
  }
}

function updateFillBlank(v) { 
  answers[questions[current].id] = v; 
  saveProgress();
}

function updateEssay(v) { 
  answers[questions[current].id] = v; 
  saveProgress(); 
}

function selectMultiple(i) {
  const qid = questions[current].id;
  if (!answers[qid]) answers[qid] = [];
  const idx = answers[qid].indexOf(i);
  if (idx === -1) {
    answers[qid].push(i);
  } else {
    answers[qid].splice(idx, 1);
  }
  render();
  saveProgress();
}

// ==================== FUNGSI TIMER & UJIAN ====================
function startTimer() {
  clearInterval(timer);
  timer = setInterval(() => {
    timeLeft--;
    
    // Auto-save setiap 10 detik
    if (timeLeft % 10 === 0) {
      saveProgress();
    }
    
    // Update timer di layar
    const timeEl = document.querySelector('.time');
    if (timeEl) {
      timeEl.innerHTML = `‚è≥ Sisa Waktu: ${Math.floor(timeLeft/60)}:${String(timeLeft%60).padStart(2,'0')}`;
    }
    
    // Waktu habis
    if (timeLeft <= 0) {
      finishTest();
    }
    
  }, 1000);
}

function startTest() {
  const nama = document.getElementById('namaSiswa').value.trim();
  const nisn = document.getElementById('nisn').value.trim();
  
  // Validasi
  if (!nama && !nisn) { 
    alert('Isi Nama atau NISN dulu!'); 
    return; 
  }
  
  // Validasi NISN (opsional: harus 10 digit)
  if (nisn && nisn.length < 10) {
    const lanjut = confirm(`NISN hanya ${nisn.length} digit. Biasanya 10 digit.\nLanjutkan anyway?`);
    if (!lanjut) return;
  }
  
  // Tanyakan apakah mau lanjutkan atau mulai baru
  const key = getStorageKey();
  const saved = localStorage.getItem(key);
  if (saved && !started) {
    try {
      const progress = JSON.parse(saved);
      if (!progress.finished) {
        const lanjut = confirm(`Ada ujian yang tersimpan untuk ${progress.namaSiswa || nama}.\nLanjutkan ujian sebelumnya?`);
        if (lanjut) {
          // Load progress yang ada
          loadProgress();
          return;
        }
      }
    } catch (e) {
      console.error('Error membaca progress:', e);
    }
  }
  
  // Mulai ujian baru
  const menit = parseInt(document.getElementById('setTime').value) || 30;
  timeLeft = menit * 60;
  started = true;
  finished = false;
  
  // Start timer
  startTimer();
  
  alert(`Ujian dimulai!\nüë§: ${nama || '(tanpa nama)'}\n‚è∞: ${menit} menit\n‚úÖ Jawaban otomatis tersimpan`);
  
  // Simpan progress awal
  saveProgress();
  render();
}

function finishTest() {
  if (!confirm('Yakin ingin mengumpulkan jawaban?\nSetelah dikumpulkan tidak bisa diubah lagi.')) {
    return;
  }
  
  clearInterval(timer);
  finished = true;
  
  // Hitung skor
  let total = 0, max = 0, correctCount = 0;
  questions.forEach(q => {
    const score = q.score || 1;
    max += score;
    const sc = (answers[q.id] === q.answer) ? score : 0;
    total += sc;
    if (sc > 0) correctCount++;
  });
  
  const percent = max > 0 ? Math.round((total/max)*100) : 0;
  const status = percent >= 70 ? "LULUS üéâ" : "TIDAK LULUS üí™";
  const nama = document.getElementById('namaSiswa').value.trim();
  const nisn = document.getElementById('nisn').value.trim();
  
  // Simpan hasil akhir
  saveProgress();
  
  // Sembunyikan panel soal
  document.getElementById('quiz').style.display = 'none';
  document.getElementById('panel').style.display = 'none';
  
  // Tampilkan hasil
  const resultEl = document.getElementById('result');
  resultEl.style.display = 'block';
  
  // Buat detail jawaban
  let detailHtml = '';
  questions.forEach((q, index) => {
    const a = answers[q.id];
    const sc = (a === q.answer) ? (q.score || 1) : 0;
    const maxScore = q.score || 1;
    
    let ansText = '';
    if (q.type === 'multiple_choice') {
      ansText = a !== undefined ? `${String.fromCharCode(65+a)}. ${q.choices[a]}` : '‚ùå Belum dijawab';
    } else if (q.type === 'fill_blank') {
      ansText = a ? `"${a}"` : '‚ùå Belum dijawab';
    } else if (q.type === 'essay') {
      ansText = a ? (a.length > 50 ? a.substring(0, 50) + '...' : a) : '‚ùå Belum dijawab';
    } else {
      ansText = a !== undefined ? JSON.stringify(a) : '‚ùå Belum dijawab';
    }
    
    const correctAnswer = q.type === 'multiple_choice' 
      ? `${String.fromCharCode(65+q.answer)}. ${q.choices[q.answer]}`
      : q.answer;
    
    detailHtml += `
      <div style="margin-bottom:12px; padding:12px; border:1px solid #e5e7eb; border-radius:8px; background:${sc > 0 ? '#f0fdf4' : '#fef2f2'}">
        <strong>Soal ${index+1}:</strong> ${q.q.length > 80 ? q.q.substring(0,80)+'...' : q.q}<br>
        <strong>Jawaban Anda:</strong> ${ansText}<br>
        <strong>Jawaban Benar:</strong> ${correctAnswer}<br>
        <strong>Skor:</strong> ${sc}/${maxScore}
      </div>
    `;
  });
  
  resultEl.innerHTML = `
    <h2 style="text-align:center; color:#0e639c;">üìä HASIL TES</h2>
    <div class="score-display">${total} / ${max} (${percent}%) ‚Äî ${status}</div>
    
    <div style="background:#f8fafc; padding:15px; border-radius:8px; margin:15px 0;">
      <p><strong>üë§ Nama Siswa:</strong> ${nama || '(tanpa nama)'}</p>
      ${nisn ? `<p><strong>üî¢ NISN:</strong> ${nisn}</p>` : ''}
      <p><strong>üìÖ Tanggal:</strong> ${new Date().toLocaleString('id-ID')}</p>
      <p><strong>üìÇ Paket Soal:</strong> ${currentFileName.replace('.json', '')}</p>
      <p><strong>‚úÖ Soal Terjawab Benar:</strong> ${correctCount} dari ${questions.length}</p>
      <p><strong>‚è∞ Status:</strong> ${status}</p>
    </div>
    
    <h3>üìù Detail Jawaban</h3>
    <div style="max-height:400px; overflow-y:auto; margin:15px 0; padding:10px; border:1px solid #e5e7eb; border-radius:8px;">
      ${detailHtml}
    </div>
    
    <div style="text-align:center; margin-top:20px;">
      <button onclick="exportJawaban()" style="padding:12px 24px; background:#059669; margin:5px;">üì• Ekspor Jawaban (JSON)</button>
      <button onclick="cetakHasil()" style="padding:12px 24px; background:#0e639c; margin:5px;">üñ®Ô∏è Cetak Hasil</button>
      <button onclick="resetUjian()" style="padding:12px 24px; background:#dc2626; margin:5px;">üîÑ Ujian Baru</button>
    </div>
  `;
}

// ==================== FUNGSI TAMBAHAN ====================
function lanjutkanUjian() {
  const nama = document.getElementById('namaSiswa').value.trim();
  const nisn = document.getElementById('nisn').value.trim();
  
  if (!nama && !nisn) {
    alert('Isi Nama atau NISN dulu!');
    return;
  }
  
  // Load progress yang tersimpan
  if (loadProgress()) {
    if (finished) {
      alert('Ujian ini sudah selesai. Lihat hasil di bawah.');
    } else {
      alert(`Ujian dilanjutkan! Sisa waktu: ${Math.floor(timeLeft/60)}:${String(timeLeft%60).padStart(2,'0')}`);
      render();
    }
  } else {
    alert('Tidak ada data ujian yang bisa dilanjutkan.');
  }
}

function hapusProgressSiswa() {
  const nama = document.getElementById('namaSiswa').value.trim();
  const nisn = document.getElementById('nisn').value.trim();
  
  if (!nama && !nisn) {
    alert('Isi Nama atau NISN dulu!');
    return;
  }
  
  const key = getStorageKey();
  if (confirm(`Yakin hapus semua data ujian untuk ${nama || nisn}?\nData akan dihapus permanen!`)) {
    localStorage.removeItem(key);
    alert('‚úÖ Data ujian dihapus!');
    location.reload();
  }
}

function resetUjian() {
  if (confirm('Mulai ujian baru?\nJawaban yang belum disimpan mungkin hilang.')) {
    // Reset state
    answers = {};
    marked = {};
    current = 0;
    started = false;
    finished = false;
    timeLeft = 0;
    clearInterval(timer);
    
    // Reset form (opsional)
    // document.getElementById('namaSiswa').value = '';
    // document.getElementById('nisn').value = '';
    document.getElementById('setTime').value = 30;
    
    // Tampilkan halaman awal
    render();
    
    // Sembunyikan hasil
    document.getElementById('result').style.display = 'none';
    document.getElementById('quiz').style.display = 'block';
    document.getElementById('panel').style.display = 'block';
  }
}

function cekDataSiswa() {
  const nama = document.getElementById('namaSiswa').value.trim();
  const nisn = document.getElementById('nisn').value.trim();
  const key = getStorageKey();
  
  console.log('üîç DEBUG DATA SISWA:');
  console.log('NISN:', nisn || '(kosong)');
  console.log('Nama:', nama || '(kosong)');
  console.log('Key:', key);
  console.log('Started:', started);
  console.log('Finished:', finished);
  console.log('Answers:', Object.keys(answers).length, 'soal');
  
  // Cek localStorage
  const saved = localStorage.getItem(key);
  if (saved) {
    try {
      const data = JSON.parse(saved);
      console.log('‚úÖ DATA TERSIMPAN:', data);
      
      const totalJawaban = Object.keys(data.answers || {}).length;
      alert(`‚úÖ DATA DITEMUKAN!\n\n` +
            `Nama: ${data.namaSiswa || '(tidak ada)'}\n` +
            `NISN: ${data.nisn || '(tidak ada)'}\n` +
            `Jawaban: ${totalJawaban} soal\n` +
            `Status: ${data.finished ? 'SELESAI' : 'BERJALAN'}\n` +
            `Sisa Waktu: ${Math.floor(data.timeLeft/60)}:${String(data.timeLeft%60).padStart(2,'0')}\n\n` +
            `Lihat console (F12) untuk detail.`);
    } catch (e) {
      console.error('Data corrupt:', e);
      alert('‚ùå Data corrupt!');
    }
  } else {
    console.log('‚ùå TIDAK ADA DATA TERSIMPAN');
    alert('Tidak ada data tersimpan untuk siswa ini.');
  }
  
  // Tampilkan semua data di localStorage
  console.log('üì¶ SEMUA DATA DI LocalStorage:');
  for (let i = 0; i < localStorage.length; i++) {
    const k = localStorage.key(i);
    if (k.startsWith('examProgress_')) {
      console.log(k);
    }
  }
}

function exportJawaban() {
  const nama = document.getElementById('namaSiswa').value.trim() || 'Anonim';
  const nisn = document.getElementById('nisn').value.trim();
  
  // Ambil nama paket
  let namaPaket = currentFileName.replace('.json', '');
  if (!namaPaket || namaPaket === 'soal') {
    const urlParams = new URLSearchParams(window.location.search);
    const mapelParam = urlParams.get('mapel');
    namaPaket = mapelParam || 'soal';
  }
  
  // Data yang akan diekspor
  const data = { 
    siswa: {
      nama: nama,
      nisn: nisn || null
    },
    ujian: {
      tanggal: new Date().toISOString(),
      waktuUjian: document.getElementById('setTime').value,
      paketSoal: namaPaket,
      totalSkor: questions.reduce((sum, q) => sum + (answers[q.id] === q.answer ? (q.score || 1) : 0), 0),
      totalMaksimal: questions.reduce((sum, q) => sum + (q.score || 1), 0),
      jumlahSoal: questions.length,
      jumlahTerjawab: Object.keys(answers).filter(k => answers[k] !== undefined && answers[k] !== '').length
    },
    jawaban: answers,
    soal: questions.map(q => ({
      id: q.id,
      pertanyaan: q.q,
      tipe: q.type,
      jawaban_benar: q.answer,
      skor: q.score || 1
    }))
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  
  // Nama file
  const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
  const namaFile = `Jawaban_${nama.replace(/\s+/g,'_')}_${namaPaket}_${timestamp}.json`;
  a.download = namaFile;
  
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  alert(`‚úÖ Jawaban berhasil diekspor!\nFile: ${namaFile}`);
}

function cetakHasil() {
  window.print();
}

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
  // Load soal
  loadSoalJSON();
  
  // Coba auto-load dari URL parameter
  const urlParams = new URLSearchParams(window.location.search);
  const siswaParam = urlParams.get('siswa');
  if (siswaParam) {
    // Auto-isi jika ada parameter siswa di URL
    document.getElementById('nisn').value = siswaParam;
  }
  
  console.log('‚úÖ Sistem Ujian Online siap!');
  console.log('üìù Fitur: Auto-save, Multi-siswa, Resume, Export JSON');
});
</script>
</body>
</html>
